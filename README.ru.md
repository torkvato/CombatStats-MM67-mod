# CombatStats и Convenience MM7 mod

## Возможности мода
CombatStats и Convenience MM7 mod не влияют на игровой процесс, игровую механику или сложность оригинальной игры. \
Мод требует патч Grayface и MMExtension, но ничего не добавляет и не меняет игру сверх этого
Мод может работать с любой сохраненной игрой, нет необходимости начинать новую. Сохранения останутся нетронутыми, если вы удалите мод (но зачем?).\
По сути, это тот же старый добрый ванильный Might and Magic 7, без каких-либо попыток сделать вечную классику сложнее/интереснее/новее.

Однако для удобства и глубокого анализа группы были введены следующие функции:

- **Классический файл журнала боя**
- Регистрация каждого нанесенного (и полученного) урона с меткой времени, игроком, целью, размером урона, типом и источником (ближний бой, дальний бой или определенное заклинание)
- Формат сохранения CSV, настраиваемый
- Вы можете выполнять собственный анализ и обработку, но основные вещи уже реализованы в игре
- **История внутриигровых боев**
- Стиль MM9, показывающий подробности последних дюжины ударов группы/монстров
- Раскрашено для удобства использования
- **Обработка статистики урона в игре**
- Накопление данных об уроне, таких как общий нанесенный урон и средний [наблюдаемый] DPS для ближнего боя/дальнего боя/магии
- Внутриигровые таблицы для сравнения эффективности членов группы
- Выбранный сегмент/текущая карта/общие данные игры в отдельных таблицах
- Экспорт статистики в выходной файл для дальнейшего использования
- **Расширенная страница персонажа**
- Атрибуты цвета ствола (спасибо MAW) с текущим значением модификатора и следующим этапом атрибута в подсказке
- Сопротивления цвета стихий со средним процентом сопротивления и шансами «плохих вещей»
- Окончательная метрика урона в ближнем и дальнем бою в виде тщательно [рассчитанного] DPS для выбора лучшей комбинации оружия
- Эффективное здоровье («Жизнеспособность»), использующее HP, класс брони (физическое избегание) и сопротивление магии в единой метрике
- Подсказки навыков, например, общая скидка торговца или текущий навык разоружения в зависимости от сложности области [Необязательно]
- **Удобные функции**
- Автоматическая сортировка предметов. Заимствовано из мода MAW MMMerge с небольшими изменениями (алхимия/сортировка неопознанных предметов).
- Полный график путешествий / Карта мира / Учителя / Таблица рецептов алхимии в Autonotes (вкладка Seer) [Необязательно]
- Обмен максимальным ID предмета и навыками ремонта в группе [Необязательно]
- Информация о ID монстра Grandmaster при нажатии ALT [Необязательно]
- Оповещение об истечении срока действия баффа (больше нет слабости от пропущенного Haste) [Необязательно]

## Установка
- Версия MM7 GOG (не забудьте установить параметры совместимости с WinXP)
- Последний патч Grayface MM7 (протестирован для 2.5.7): https://grayface.github.io/mm/#GrayFace-MM7-Patch
- Невыпущенное MMExtension v2.3: https://github.com/GrayFace/MMExtension
- Этот мод. Последняя версия в репозитории

Вместо двух последних шагов можно загрузить весь пакет с последней стабильной версией\
**https://drive.google.com/file/d/1d-jrk6c59oIQVuf44gHe7W3GgHkodMEo**

**Важное примечание: поскольку мелкие исправления все еще выпускаются, рекомендуется загрузить последнюю версию из репозитория, даже если вы скачали полный пакет**\
- Удаление: запустите ccUninst.bat в папке Scripts. Установка и удаление модов не влияет на игровой процесс
- Сообщения об ошибках и поддержка в группе TG - https://t.me/+WAc2jt1nvT1iMzIy

**Конфигурация**
Вы можете проверить доступные параметры конфигурации в файле Scripts/General/ccInit.lua

## Благодарности
Этот мод является осуществлением давней мечты, мечты увидеть в деталях, что происходит с командой героев, мечты получить реальные данные для бесконечных споров о том, кто лучше.\
Долгое время я не знал, как подступиться к этой задаче, пока не увидел мод MAW\
https://github.com/malekitsu/maw-mod-mmmerge

и не впал в его азарт, наслаждаясь как игровым процессом, так и новыми знаниями о моддинге.

Мод MAW, разработанный **Malekith** и его командой, стал для меня просто откровением.

Оттуда я позаимствовал много того, что впервые появилось в MAW - цвета атрибутов, отображение характеристик DPS и Vitality и, конечно же, замечательную автосортировку инвентаря, без которой я теперь просто не могу играть.\
Но прямое копирование кода было не главным - мод MAW показал мне, что все возможно, и показал, как это можно сделать, заглянув в его код, я открыл для себя и Lua, и MMExtension.

Еще один замечательный человек, который фактически сделал возможным любой моддинг MM, и **Grayface**, автор MMExtension. Мы просто не можем недооценивать его влияние на сообщество MM, как моддеров, так и геймеров.

## Подробное описание

### Журнал боя
Включение опции журнала боя создаст файл .csv в каталоге игры и будет регистрировать в нем все [успешные] попадания.\
Вы можете полностью отключить журнал боя (CombatLogEnabled=0), регистрировать только урон группы (CombatLogEnabled=1) и урон группы и монстров (CombatLogEnabled=2)\
Также в файле конфигурации вы можете указать разделитель журнала, но изменение порядка и добавление новых данных потребуют более подробных изменений кода\

4,993 / 5,000
Журнал боя постоянно пополняется новыми записями, поэтому он сохранит все, даже если вы перезагрузите игру или создадите новую группу.\
Любое управление журналом должно осуществляться вручную.

Поля:
- Временная метка в игровых тиках. 256 тиков = 1 игровая минута = 2 секунды реального времени = 120 очков «восстановления оружия».

Номер игрока (0-3)
- Класс и уровень игрока
- Имя игрока
- Индикатор направления удара, указывает на цель
- Имя монстра
- Нанесенный урон
- Вид урона (Огонь, Воздух, Тьма и т. д.)
- Источник урона, удар в ближнем бою, выстрел из лука/бластера или определенное заклинание с его навыком и мастерством

Поскольку игра обрабатывает каждый случай урона отдельно, удар элементарным зачарованным оружием даст две строки в журнале боя. То же самое с дробовиком/AoE-заклинаниями (кроме Армагеддона)

### Внутриигровая история сражений
Помимо вывода в файл, нанесенный и полученный урон можно просмотреть в истории сражений в стиле MM9 (клавиша по умолчанию -[H] )
Внутриигровой журнал сражений имеет меньше полей из-за нехватки места, но в настоящее время показывает уровень мода для справки

![image](https://github.com/user-attachments/assets/9d772466-850e-4028-a236-58e3fd3a6d5c)

### Статистика боя
**Нанесенный урон**\
Мод накапливает и хранит урон, нанесенный группой и монстрами.\
Урон делится на три категории: *Ближний бой*, *Дистанционный бой* (луки и бластеры) и *Заклинание*, каждая категория обрабатывается индивидуально для каждого члена группы.

Кроме того, есть три различных пула накопления:
- Данные карты/локации: специфичные для определенной внутренней/наружной области, сохраняются до возрождения карты (примерно через 2 года)
- Полные данные: общая статистика с самого начала
- Данные сегмента: статистика с момента последнего ручного сброса ([R] на странице персонажа)

Сводки статистики можно получить, щелкнув [правой кнопкой мыши] в области DPS/Vitality на странице персонажа\
Здесь вы также можете [Экспортировать] эти таблицы в файл для дальнейшего использования.

**Наблюдаемый DPS**\
DPS или урон в секунду является наиболее важным показателем боевого мастерства. Здесь мы рассчитываем общий урон, нанесенный игроком, деленный на общее активное время\
Расчет активного времени может быть сложным и спорным. В настоящее время активное время рассчитывается с первого успешного попадания и заканчивается, если в течение 5 секунд нет успешных попаданий. DPS рассчитывается для каждого члена группы независимо и по тем же трем пулам накопления данных: карта, полный и сбрасываемый сегмент.

![image](https://github.com/user-attachments/assets/fc77963c-196b-4448-b2b7-a148eb8a0734)

**Полученный урон**
Полученный урон на каждого члена группы накапливается по карте/полной игре/сегменту и шоуну в одной из таблиц [ALT-Click].

В настоящее время он делится на ближний бой/дальний бой/заклинание.

Учитывается только урон, нанесенный монстрами (и другими заклинателями).

У ловушек и урона от падения нет «автора», и они [пока] не включены в статистику.

**Записи**
Мод будет записывать лучшие удары ближнего боя, дальнего боя и магии отдельно (также независимо для трех наборов данных: карта, полный и сегмент)\
Чтобы преодолеть проблему нескольких видов урона/нескольких источников урона на удар, добавлена ​​логика накопления.\
Урон считается одним ударом, если он происходит в одну и ту же временную метку, нанесен одним и тем же игроком и против монстра с тем же именем.\
Таким образом, удар ближнего боя с уроном Phys+Fire будет суммироваться, урон Fireball против группы монстров с одинаковым именем будет суммироваться, а против группы монстров с разными именами — нет.

### Расчетная статистика
**Урон в секунду, DPS**
- Процент попадания рассчитывается на основе текущего модификатора To-Hit против моба с AC, равным текущему уровню игрока\
*P = (15 + PlayerAttack * 2) / (30 + PlayerAttack * 2 + AC)*\
Для расчета мы используем грубый скейлинг прогресса монстров, а их AC (и Lvl) предполагается равным 3x Party Lvl (но не более 100)

- Расчетный DPS рассчитывается на основе базового среднего урона, который учитывает
- Вероятность промаха
- Базовый урон оружия с уже учтенными Силой/Героизмом (указано в оригинальной части экрана персонажа)
- Постоянный и временный стихийный урон для обоих видов оружия (и артефактов/реликвий)
- Шанс утроения базового урона Мастерства кинжалов
- Усиление Рук-молотов\
Не учитываются: Слабость, Бонусы расовых особенностей, Сопротивления монстров\
Среднее Урон делится на текущее значение восстановления в секундах, чтобы получить окончательное отображаемое значение DPS, которое включает все факторы, влияющие на выходной урон, и, таким образом, может использоваться для сравнения оружия

**Жизненная сила (эффективное здоровье)**
Жизненная сила рассчитывается с учетом шанса уклонения от физических ударов игрока (определяется AC) и магических сопротивлений.
В настоящее время эффект AC берется с весом 65%, элементарные магические сопротивления имеют по 7,5%, сопротивления разума и тела по 2,5%. Эти веса подходят для группы, участвующей в ближнем бою и имеющей вора.
Если вы предпочитаете ловушки, которые взрываются у вас в лицо, и разбираетесь с мобами издалека, то, безусловно, элементальная часть должна иметь большее влияние на результат. Альтернативная конфигурация также включена в файл cmInit.lua.
![изображение](https://github.com/user-attachments/assets/af850de2-4130-4086-9869-45d0ba30b621)

## Управление инвентарем
Очень полезная функция мода — сортировка всего инвентаря группы или одного игрока нажатием одной кнопки (кнопки [T] и [R])
Сортировка перестраивает инвентарь, помещая самые крупные предметы на первое место и заполняя пробелы более мелкими, что позволяет освободить немного места.
Кроме того, можно назначить игрока для предметов, связанных с алхимией ([Y]).
После сортировки этот игрок получит следующие предметы в следующем порядке:
1. Снаряжение с бонусом +Alchemy, если оно есть
2. Пустые бутылки, бутылки с катализаторами и все простые зелья: R,B,Y,P,O,G
3. Катализаторы в порядке возрастания силы
4. Ингредиенты в порядке R-B-Y
5. Остальные зелья — многослойные, белые и черные

Если инвентарь игрока с алхимией заполнен (всегда сохраняется 2 места), следующий игрок получит предметы. Для последнего (четвертого) игрока, следующим игроком будет третий

Те, кто не хочет использовать даже "мягкие" читы и делиться ID. Навыками предметов среди группы, могут установить игрока для них ([U])

## Дополнительные удобные функции

**Справочная информация**\
Полезная информация об игре обобщена в нескольких удобных таблицах, включая полное расписание конюшен/лодок, карту межрегиональных путешествий, местоположения техеров (только регион) и полный сборник алхимии.
Каждый раздел может быть независимо включен/отключен в файле Scripts/ccInit.lua.

**Общий ID предмета и навык ремонта**

## Стандартные сочетания клавиш

**История боев**\
[H], как это было в MM9. Это перекрывает исторические заметки Венделла Твида, поэтому, если вам действительно нужны его работы, вы можете получить к ним доступ через книгу или переназначить клавишу в меню
**Статистика урона**\
[Щелкните правой кнопкой мыши] на экране статистики игрока: нажатие на статистику DPS приведет к данным сегмента, нажатие на Vitality приведет к данным карты\
[ALT]+[Щелкните правой кнопкой мыши] приводит к полной статистике с начала игры\
[E] и затем [Y] для экспорта таблиц в файл\
[R] и затем [Y] для сброса данных сегмента\
**Управление инвентарем**\
[R] для сортировки текущего инвентаря игрока\
[T] для сортировки инвентаря группы\
[Y] для выбора/отмены выбора назначенного игрока для Алхимии\
[U] для выбора/отмены выбора назначенного игрока для Неопознанных предметов\
**Дополнительные заметки**\
[N] Дополнительные заметки, добавленные на вкладку Seer в Autonotes
- Расписание поездок
- Карта мира
- Таблица учителей
- Рецепты алхимии

**ID Monster**\
Если соответствующая опция в разделе «Мягкие читы» включена, [ALT] при проверке характеристик монстра выдаст полную информацию GM
![изображение](https://github.com/user-attachments/assets/3dab06e0-7dfb-44da-a8cd-d3c2e0be0c9f)
