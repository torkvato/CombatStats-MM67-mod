# CombatStats и Convenience MM7 mod

## Возможности мода
CombatStats и Convenience MM7 mod не влияет на игровой процесс, игровую механику или сложность оригинальной игры. \
Мод требует патч Grayface и MMExtension, но ничего не добавляет и не меняет игру сверх этого
Мод может работать с любой сохраненной игрой, нет необходимости начинать новую. Сохранения останутся нетронутыми, если вы удалите мод (но зачем?).\
По сути, это тот же старый добрый ванильный Might and Magic 7, без каких-либо попыток сделать вечную классику сложнее/интереснее/новее.

Однако для удобства и глубокого анализа группы были введены следующие функции:

- **Классический журнал боя**
- Регистрация каждого нанесенного (и полученного) урона с меткой времени, игроком, целью, размером урона, типом и источником (ближний бой, дальний бой или определенное заклинание)
- Формат сохранения CSV, настраиваемый
- Вы можете выполнять собственный анализ и обработку, но основные вещи уже реализованы в игре
- **Журнал боя в игре**
- История последних ударов, как в ММ9
- Цвета по типу урона
- **Обработка статистики урона в игре**
- Накопление данных, таких как общий нанесенный урон и средний [наблюдаемый] DPS для ближнего боя/дальнего боя/магии
- Внутриигровые таблицы для сравнения эффективности членов группы
- Выбранный сегмент/текущая карта/общие данные за всю игру в отдельных таблицах
- Экспорт статистики в файл на память
- **Расширенная страница персонажа**
- Атрибуты (по цветам бочек) (спасибо MAW моду) с текущим значением модификатора
- Сопротивления магиям в процентах, по цветам стихий. Шансы негативных эффектов в зависимости оти типа сопротивления
- Окончательная метрика урона в ближнем и дальнем бою в виде тщательно [рассчитанного] DPS для выбора лучшей комбинации оружия
- Эффективное здоровье («Vitality»), использующее HP, класс брони (шанс промаха врога) и сопротивление магии в единой метрике
- Подсказки навыков, например, общая скидка торговца или текущий навык обезвреживания ловушек в зависимости от сложности области [Необязательно]
- **Удобные функции**
- Автоматическая сортировка предметов. Заимствовано из мода MAW MMMerge с небольшими изменениями (алхимия/сортировка неопознанных предметов).
- Полное расписание путешествий / Карта мира / Учителя / Таблица рецептов алхимии в Autonotes (вкладка Seer) [Необязательно]
- Максимальный навык идентификации предмета и ремонта действует для всей группы [Необязательно]
- Грандмастерская идентификация монстра при нажатии ALT [Необязательно]
- Оповещения об истечении срока действия баффов (больше нет слабости от пропущенного Haste) [Необязательно]
- Будильник чтоб не пропустить закрытие магазинов [Необязательно]

## Установка мода
- Версия MM7 от GOG (не забудьте установить параметры совместимости с WinXP)
- Последний патч Grayface MM7 (протестирован для 2.5.7): https://grayface.github.io/mm/#GrayFace-MM7-Patch
- MMExtension v2.3: https://github.com/GrayFace/MMExtension
- Этот мод. Последняя версия в репозитории https://github.com/torkvato/CombatStats-MM7-mod (Code > Download ZIP)

Вместо двух последних шагов можно загрузить весь пакет с последней стабильной версией\
**https://drive.google.com/file/d/1d-jrk6c59oIQVuf44gHe7W3GgHkodMEo**

**Важное примечание: поскольку мелкие исправления все еще выпускаются, рекомендуется загрузить последнюю версию из репозитория, даже если вы скачали полный пакет**\
- Удаление: запустите ccUninst.bat в папке Scripts. Установка и удаление модов не влияет на игровой процесс
- Сообщения об ошибках и поддержка в группе TG - https://t.me/+WAc2jt1nvT1iMzIy

**Конфигурация**
Вы можете проверить доступные параметры конфигурации в файле Scripts/General/ccInit.lua\ 
Отключить то что вы считаете читерским, посмотреть или переназначить управление.


## Благодарности
Этот мод является осуществлением давней мечты, мечты увидеть в деталях, что происходит с командой героев, мечты получить реальные данные для бесконечных споров о том, кто лучше.\
Долгое время я не знал, как подступиться к этой задаче, пока не увидел мод MAW\
https://github.com/malekitsu/maw-mod-mmmerge

Я был буквально поглощен им несколько месяцев, наслаждаясь как игровым процессом, так и новыми знаниями о моддинге.

Мод MAW, разработанный **Malekith** и его командой, стал для меня просто откровением.

Оттуда я позаимствовал много того, что впервые появилось в MAW - цвета атрибутов, отображение характеристик DPS и Vitality и, конечно же, замечательную автосортировку инвентаря, без которой я теперь просто не могу играть.\
Но прямые заимствования это далеко не все - мод MAW показал мне, что все возможно, и показал, как это можно сделать, заглянув в его код, я открыл для себя и Lua, и MMExtension.

Еще один замечательный человек, который фактически сделал возможным любой моддинг MM - **Grayface**, автор MMExtension. Просто невозможно недооценить его влияние на сообщество MM, как моддеров, так и геймеров.

## Подробное описание мода

### Журнал боя
Включение опции журнала боя создаст файл .csv в каталоге игры и будет регистрировать в нем все [успешные] попадания.\
Вы можете полностью отключить журнал боя (CombatLogEnabled=0), регистрировать только урон группы (CombatLogEnabled=1) и урон группы и монстров (CombatLogEnabled=2)\
Также в файле конфигурации вы можете указать разделитель журнала, но изменение порядка и добавление новых данных потребуют более подробных изменений кода\

Журнал боя постоянно пополняется новыми записями, поэтому он сохранит все, даже если вы перезагрузите игру или создадите новую группу.\
Любое управление журналом должно осуществляться вручную.

Поля:
- Временная метка в игровых "тиках". 256 тиков = 1 игровая минута = 2 секунды реального времени = 120 очков "восстановления"/ "Recovery".
- Номер игрока (0-3) 
- Класс и уровень игрока
- Имя игрока
- Индикатор направления удара >> или <<, указывает на цель
- Имя монстра
- Нанесенный урон
- Вид урона (Огонь, Воздух, Тьма и т. д.)
- Источник урона, удар в ближнем бою, выстрел из лука/бластера или определенное заклинание с его навыком и мастерством

Поскольку игра обрабатывает каждый случай урона отдельно, удар элементарным зачарованным оружием даст две строки в журнале боя. То же самое с AoE-заклинаниями или заклинаниями типа "дробовик" (кроме Армагеддона)

### Внутриигровая история сражений
Помимо вывода в файл, нанесенный и полученный урон можно просмотреть в истории сражений в стиле MM9 (клавиша по умолчанию -[H] )

![image](https://github.com/user-attachments/assets/9d772466-850e-4028-a236-58e3fd3a6d5c)

### Статистика боя
**Нанесенный урон**\
Мод накапливает и хранит урон, нанесенный группой и монстрами.\
Урон делится на три категории: Ближний бой *Melee*, Дистанционный бой (луки и бластеры) - *Ranged* и магия *Spells*, каждая категория обрабатывается индивидуально для каждого члена группы.

Кроме того, есть три различных набора данных:
- Данные текущей локации: специфичные для определенной внутренней/наружной области, сохраняются до возрождения карты (примерно через 2 года)
- Полные данные: общая статистика с самого начала игры
- Данные сегмента: статистика с момента последнего ручного сброса ([R] на странице персонажа)

Сводки статистики можно получить, щелкнув [правой кнопкой мыши] в области DPS/Vitality на странице персонажа\
Здесь вы также можете экспортировать [E] эти таблицы в файл для дальнейшего использования.

**Наблюдаемый DPS**\
DPS или урон в секунду является наиболее важным показателем боевого мастерства. Здесь мы рассчитываем общий урон, нанесенный игроком, деленный на общее активное время\
Активное время рассчитывается с первого успешного попадания и заканчивается, если в течение 5 секунд нет успешных попаданий. DPS рассчитывается для каждого члена группы независимо и по тем же трем наборам накопления данных: локация, полный и сбрасываемый сегмент.

![image](https://github.com/user-attachments/assets/fc77963c-196b-4448-b2b7-a148eb8a0734)

**Полученный урон**
Полученный урон на каждого члена группы накапливается по локации/полной игре/сегменту и показывается в одной из таблиц [ALT-Click].
Полученный партией урон так же делится на ближний бой/дальний бой/заклинание.
Учитывается только урон, нанесенный монстрами и размещенными на карте ловушками.

Урон ловушек на сундуках и урон от падения не включены в статистику и не отображаются в логах.

**Рекорды**
Мод будет записывать лучшие удары ближнего боя, дальнего боя и магии отдельно (также независимо для трех наборов данных: карта, полный и сегмент)\
Чтобы преодолеть проблему нескольких видов урона/нескольких источников урона на удар, добавлена ​​логика накопления.\
Урон считается одним ударом, если он происходит в одну и ту же временную метку, нанесен одним и тем же игроком и против монстра с тем же именем.\
Таким образом, удар ближнего боя с уроном Phys+Fire будет суммироваться, урон Fireball против группы монстров с одинаковым именем будет суммироваться, а против группы монстров с разными именами — нет.
В походовом режиме все удары одного раунда имеют одно и того игровое время, поэтому удары за раунд тоже могут суммироваться.

### Расчетная статистика
**Урон в секунду, DPS**
- Процент попадания рассчитывается на основе текущего модификатора To-Hit против моба с известным классом брони AC\
*P = (15 + PlayerAttack * 2) / (30 + PlayerAttack * 2 + AC)*\
Для расчета считается что партия воются с более сильными монстрами и х AC (и Lvl) предполагается равным 3x Party Lvl (но не более 100)

- DPS рассчитывается на основе среднего урона, который учитывает
- Вероятность промаха
- Базовый урон оружия с уже учтенными Силой/Героизмом (числа уже указанные на страничке персонажа)
- Постоянный и временный стихийный урон для обоих видов оружия (и артефактов/реликвий) (не показан явно)
- Шанс утроения базового урона Мастерства кинжалов
- Усиление Рук-молотов\
Не учитываются: Слабость, Бонусы расовых особенностей, Сопротивления монстров\
Средний Урон делится на текущее значение "восстановления" в секундах, чтобы получить окончательное отображаемое значение DPS, которое включает все факторы, влияющие на выходной урон, и, таким образом, может использоваться для сравнения оружия

**Vitality (эффективное здоровье)**
Vitality рассчитывается с учетом шанса уклонения от физических ударов игрока (определяется AC) и магических сопротивлений.
Веса сопротивлений урону рассчитываются на основе анализа входящего урона для полного прохождения игры хорошо пробафанной группой (светлая сторон, TKPS)
Чтобы учесть типы урона к которым нет сопротивления, такие как энергия, тьма и свет, простое Здоровье также является частью окончательной метрики
![изображение](https://github.com/user-attachments/assets/af850de2-4130-4086-9869-45d0ba30b621)

## Управление инвентарем
Очень полезная функция мода — сортировка всего инвентаря группы или одного игрока нажатием одной кнопки (кнопки [T] и [R])
Сортировка перестраивает инвентарь, помещая самые крупные предметы на первое место и заполняя пробелы более мелкими, что позволяет освободить немного места.
Кроме того, можно назначить игрока для предметов, связанных с алхимией ([Y]).
После сортировки этот игрок получит следующие предметы в следующем порядке:
1. Снаряжение с бонусом +Alchemy, если оно есть
2. Пустые бутылки, бутылки с катализаторами и все простые зелья: R,B,Y,P,O,G
3. Катализаторы в порядке возрастания силы
4. Ингредиенты в порядке R-B-Y
5. Остальные зелья — многослойные, белые и черные

Если инвентарь игрока с алхимией заполнен (всегда сохраняется 2 места), следующий игрок получит остальное. Для последнего (четвертого) игрока, следующим игроком будет третий. 
Так же есть возможность установить игрока который будет собирать неидентифицированные предметы [U], если вы по какой-то причине не отключили функцию расшаривания умения идентификации

## Дополнительные функции для удобства

**Справочная информация**\
Полезная информация об игре обобщена в нескольких удобных таблицах, включая полное расписание конюшен/лодок, карту регионов, местоположение учителей и полный сборник рецептов алхимии.
Каждый раздел может быть независимо включен/отключен в файле Scripts/ccInit.lua.

**Общий ID предмета и навык ремонта**

**Предупреждение об окончании баффов**
Список отслеживаемых заклинаний может быть сконфигурирован в Scripts/ccInit.lua
Используйте  https://grayface.github.io/mm/ext/ref/#const.PartyBuff и https://grayface.github.io/mm/ext/ref/#const.PlayerBuff для точного имени.

**Простой будильник**
Устанавливается в инициализационном файле в 24ч формате, например "17:30" или можно оставить пустым для отключения ""
Время, конечно же, игровое. Чтобы не пропустить закрытие магазинов, например.

## Стандартные сочетания клавиш

**История боев**\
[H], как это было в MM9. Это перекрывает исторические заметки Венделла Твида, поэтому, если вам действительно нужны его работы, вы можете получить к ним доступ через книгу или переназначить клавишу в меню
**Статистика урона**\
[RClick] на экране статистики игрока: нажатие на статистику DPS приведет к данным сегмента, нажатие на Vitality приведет к данным локации\
[ALT]+[RClick] приводит к полной статистике с начала игры\
На экране статистики персонажа:
[E] и затем [Y] для экспорта таблиц в файл\
[R] и затем [Y] для сброса данных сегмента\
**Управление инвентарем**\
[R] для сортировки текущего инвентаря игрока\
[T] для сортировки инвентаря группы\
[Y] для выбора/отмены выбора назначенного игрока для Алхимии\
[U] для выбора/отмены выбора назначенного игрока для Неопознанных предметов\
**Дополнительные заметки**\
[N] Дополнительные заметки, добавленные на вкладку Seer в Autonotes
- Расписание поездок
- Карта мира
- Таблица учителей
- Рецепты алхимии

**ID Monster**\
Если соответствующая опция в разделе «легкие читы» включена, [ALT] при проверке характеристик монстра выдаст полную информацию GM
![изображение](https://github.com/user-attachments/assets/3dab06e0-7dfb-44da-a8cd-d3c2e0be0c9f)
